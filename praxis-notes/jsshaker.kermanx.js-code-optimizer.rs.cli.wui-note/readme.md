[src/gh]: https://github.com/kermanx/jsshaker.git "(Languages: Rust 90.6%, JavaScript 5.8%, Vue 1.8%, TypeScript 1.6%, CSS 0.1%, HTML 0.1%) ğŸªš Code size optimizer for JavaScript // ğŸªš JavaScript ä»£ç å¤§å°ä¼˜åŒ–å·¥å…· /// Features // ç‰¹æ€§ /// - Simulate the runtime behavior of the code, instead of applying rules. // æ¨¡æ‹Ÿä»£ç çš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œè€Œä¸æ˜¯åº”ç”¨è§„åˆ™ã€‚ /// - Single AST pass - Analyzer as much information as possible. // å•æ¬¡ AST éå† - å°½å¯èƒ½åˆ†ææ›´å¤šä¿¡æ¯ã€‚ /// - As accurate as possible. test262 is used for testing. // å°½å¯èƒ½å‡†ç¡®ã€‚ä½¿ç”¨ test262 è¿›è¡Œæµ‹è¯•ã€‚ /// - May not be the fastest. (But I will try my best) // å¯èƒ½ä¸æ˜¯æœ€å¿«çš„ã€‚ï¼ˆä½†æˆ‘å°†å°½åŠ›è€Œä¸ºï¼‰ /// Examples // ç¤ºä¾‹ /// - Constant Folding // å¸¸é‡æŠ˜å  ///: This is a simple example, but it's a good start. // è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªå¥½çš„å¼€å§‹ã€‚ ///; Input (: export function f() { function g(a) { if (a) console.log('effect'); else return 'str'; } let { ['x']: y = 1 } = { x: g('') ? undefined : g(1) }; return y; }) Output (: export function f() { return 1; }) /// - Remove Dead Code // ç§»é™¤æ— ç”¨ä»£ç  ///: The core of tree-shaking. The execution is simulated to know which code is useless. // æ ‘æ‘‡åŠ¨çš„æ ¸å¿ƒã€‚é€šè¿‡æ¨¡æ‹Ÿæ‰§è¡Œæ¥è¯†åˆ«å“ªäº›ä»£ç æ˜¯æ— ç”¨çš„ã€‚ ///; And don't worry about the && true in the output, minifier will remove it. // è€Œä¸”ä¸ç”¨æ‹…å¿ƒè¾“å‡ºä¸­çš„ && true ï¼Œå‹ç¼©å™¨ä¼šå°†å…¶ç§»é™¤ã€‚ ///; Input (: function f(value) { if (value) console.log(`${value} is truthy`); } f(1); f(0); function g(t1, t2) { if (t1 && t2) console.log(2); else if (t1 || t2) console.log(1); else console.log(0); } g(true, true); g(false, false);) Output (: function f() { { console.log('1 is truthy'); } } f(); function g(t1) { if (t1 && true) console.log(2); else { console.log(0); } } g(true); g(false);) /// - Object Property Mangling // å¯¹è±¡å±æ€§æ··æ·† ///: This is beyond the scope of tree-shaking, we need a new name for this project ğŸ˜‡. // è¿™è¶…å‡ºäº†æ‘‡æ ‘ä¼˜åŒ–çš„èŒƒå›´ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºè¿™ä¸ªé¡¹ç›®èµ·ä¸€ä¸ªæ–°çš„åå­— ğŸ˜‡ã€‚ ///; Input (: export function main() { const obj = { foo: v1, [t1 ? 'bar' : 'baz']: v2, }; const key = t2 ? 'foo' : 'bar'; console.log(obj[key]); }) Output (: export function main() { const obj = { a: v1, [t1 ? 'b' : 'c']: v2, }; const key = t2 ? 'a' : 'b'; console.log(obj[key]); }) /// - Class Tree Shaking // ç±»æ ‘æ‘‡åŠ¨ ///: One of the hardest but the coolest. // æœ€éš¾ä½†æœ€é…·çš„ä¸€é¡¹ã€‚ ///; Input (: class A { method(x) { console.log('A', x); } static static_prop = unknown; } class B extends A { method(x) { console.log('B', x); } unused() { console.log('unused'); } } new B().method(A.static_prop);) Output (: class A { static a = unknown; } class B extends A { a(x) { console.log('B', x); } } new B().a(A.a);) /// - JSX ///: createElement also works, if it is directly imported from react. // å¦‚æœ createElement æ˜¯ç›´æ¥ä» react å¯¼å…¥çš„ï¼Œå®ƒä¹Ÿé€‚ç”¨ã€‚ ///; Input (: function Name({ name, info }) { return (<span>{name}{info && <sub> Lots of things never rendered </sub>}</span>); } export function Main() { return <Name name={'world'} />; }) Output (: function Name() { return (<span>{'world'}{}</span>); } export function Main() { return <Name />; }) /// - React.js ///: We also have special handling for some React.js APIs. For example, React Context, memo, forwardRef, useMemo, etc. // æˆ‘ä»¬ä¹Ÿå¯¹ä¸€äº› React.js API æä¾›äº†ç‰¹æ®Šå¤„ç†ã€‚ä¾‹å¦‚ï¼ŒReact Contextã€ memo ã€ forwardRef ã€ useMemo ç­‰ã€‚ ///; Input (: import React from 'react'; const MyContext = React.createContext('default'); function Inner() { const value = React.useContext(MyContext); return <div>{value}</div>; } export function main() { return (<MyContext.Provider value='hello'><Inner /></MyContext.Provider>); }) Output (: import React from 'react'; const MyContext = React.createContext(); function Inner() { return <div>{'hello'}</div>; } export function main() { return (<MyContext.Provider><Inner /></MyContext.Provider>); }) /// ### Comparison // æ¯”è¾ƒ /// - Rollup: Rollup tree-shakes the code in a multi-module context, and it has information about the side effects of the modules. This project does a more fine-grained tree-shaking, and it can be used as a post-processor for Rollup, and is expected to produce smaller code. // Rollupï¼šRollup åœ¨å¤šæ¨¡å—ç¯å¢ƒä¸­è¿›è¡Œä»£ç æ‘‡æ ‘ï¼Œå¹¶ä¸”å®ƒåŒ…å«æœ‰å…³æ¨¡å—å‰¯ä½œç”¨çš„ä¿¡æ¯ã€‚è¯¥é¡¹ç›®è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ‘‡æ ‘ï¼Œå¹¶ä¸”å¯ä»¥ç”¨ä½œ Rollup çš„åå¤„ç†å™¨ï¼Œé¢„è®¡å¯ä»¥ç”Ÿæˆæ›´å°çš„ä»£ç ã€‚ /// - Closure Compiler/swc: they support both minification and dead code elimination, while this project is focused on tree-shaking (difference below). You can expect a size reduction when using JsShaker on their output, and vice versa. // Closure Compiler/swcï¼šå®ƒä»¬éƒ½æ”¯æŒä»£ç å‹ç¼©å’Œæ— ç”¨ä»£ç æ¶ˆé™¤ï¼Œè€Œæœ¬é¡¹ç›®ä¸“æ³¨äºæ‘‡æ ‘ï¼ˆä¸‹æ–‡å°†è¯´æ˜å·®å¼‚ï¼‰ã€‚å½“ä½¿ç”¨ JsShaker å¤„ç†å®ƒä»¬çš„è¾“å‡ºæ—¶ï¼Œå¯ä»¥é¢„æœŸä»£ç å¤§å°ä¼šå‡å°ï¼Œåä¹‹äº¦ç„¶ã€‚ /// ### What's Tree Shaking?  ä»€ä¹ˆæ˜¯ Tree Shakingï¼Ÿ ///: Here is a simple comparison: // è¿™é‡Œæœ‰ä¸€ä¸ªç®€å•çš„æ¯”è¾ƒï¼š /// - Minification: Removing whitespace, renaming variables, syntax-level optimizations, etc. // ä»£ç å‹ç¼©ï¼šç§»é™¤ç©ºç™½å­—ç¬¦ã€é‡å‘½åå˜é‡ã€è¯­æ³•çº§åˆ«çš„ä¼˜åŒ–ç­‰ã€‚ /// - Dead code elimination: Removing code that is never executed, by using a set of rules, for example, â€œif(false) { ... } can be removedâ€. // æ— ç”¨ä»£ç æ¶ˆé™¤ï¼šé€šè¿‡ä½¿ç”¨ä¸€ç»„è§„åˆ™ç§»é™¤ä»æœªæ‰§è¡Œçš„ä»£ç ï¼Œä¾‹å¦‚ï¼Œâ€œ if(false) { ... } å¯ä»¥è¢«ç§»é™¤â€ã€‚ /// - Tree shaking: Removing code that is never executed, by simulating the runtime behavior of the code. For example, â€œif (x) { ... } can only be preserved if ... is reachable and has side effectsâ€. // æ‘‡æ ‘ä¼˜åŒ–ï¼šé€šè¿‡æ¨¡æ‹Ÿä»£ç çš„è¿è¡Œæ—¶è¡Œä¸ºæ¥ç§»é™¤ä»æœªæ‰§è¡Œçš„ä»£ç ã€‚ä¾‹å¦‚ï¼Œâ€œ if (x) { ... } åªæœ‰åœ¨ ... å¯è¾¾ä¸”å…·æœ‰å‰¯ä½œç”¨çš„æƒ…å†µä¸‹æ‰èƒ½ä¿ç•™â€ã€‚"
[play.wui/.site]: https://kermanx.com/jsshaker/ "Try online"
